### **整体流程概述**
代码用于处理多个CSV文件（每个文件代表一个无人机的轨迹数据），核心目标是为每个无人机生成密集、平滑的航点轨迹。流程包括：
1. **数据读取与初始化**：从CSV提取初始位置和原始航点。
2. **时间轴生成**：创建匹配控制频率的密集时间序列。
3. **三次样条插值**：生成连续、平滑的密集航点。
4. **动态曲率限制**：通过加速度阈值检测和平滑处理，防止轨迹突变。
5. **输出存储**：存储处理后的航点用于后续控制。

数学上，这是一个**轨迹优化问题**：输入离散的位置-时间数据，输出物理可行的连续轨迹，确保加速度不超过物理极限（如无人机动力学约束）。最终轨迹需满足：
- **位置连续性**（$C^0$连续）。
- **速度与加速度平滑性**（$C^1$和$C^2$连续）。
- **加速度有界**（如≤2g）。

---

### **CSV文件通过Blender Skybrush获取
<img src="gym_pybullet_drones/assets/CSV.gif" alt="formation flight" width="1000"> 

### **pid_circle控制示例**
```sh
cd gym_pybullet_drones/examples/
python3 pid_circle.py
```
<img src="gym_pybullet_drones/assets/pid_circle.gif" alt="formation flight" width="1000"> 

### **分步骤数学公式与原理**
#### **1. 数据读取与初始化**
```python
df = pd.read_csv(file_path)
initial_pos = (df[["x [m]", "y [m]", "z [m]"]].iloc[0].values) / 6.0
raw_waypoints = (df[["x [m]", "y [m]", "z [m]"]].iloc[1:].values) / 6.0
```

- **数学公式**：
  - 初始位置：$\mathbf{p}_0 = \frac{1}{6} \mathbf{d}_0$，其中 $\mathbf{d}_0 = [x_0, y_0, z_0]^T$ 是CSV第一行的坐标。
  - 原始航点：$\mathbf{p}_i = \frac{1}{6} \mathbf{d}_i$（$i = 1, 2, \ldots, n-1$)，$n$为数据行数，$\mathbf{d}_i$为第$i$行坐标。
  - 时间戳：$t_j = \frac{\text{Time}_j}{1000}$（$j = 1, 2, \ldots, n-1$)，单位为秒。
- **原理**：
  - `pd.read_csv`将CSV文件解析为DataFrame，支持表格化数据处理。
  - `iloc[0]`选择第一行（索引0），`iloc[1:]`选择第二行至末尾，`.values`转换为NumPy数组。除以6.0可能是单位转换（如从毫米到米）。
- **作用**：提取离散航点作为插值基础，确保数据可操作。初始位置用于无人机初始化，后续航点定义轨迹形状。

#### **2. 密集时间轴生成**
```python
time_dense = np.linspace(start_time, end_time, int(control_freq_hz * duration_sec))
```

- **数学公式**：
  - $t_k = t_0 + k \cdot \Delta t$，其中 $\Delta t = \frac{1}{f_{\text{ctrl}}}$，$k = 0, 1, \ldots, m-1$，$m = f_{\text{ctrl}} \times T$。
  - $t_0$是第一个航点时间，$T$是总时长（`duration_sec`），$f_{\text{ctrl}}$是控制频率（`control_freq_hz`）。
- **原理**：生成等间隔时间序列，步长$\Delta t$由控制频率决定。例如，若$f_{\text{ctrl}} = 100\,\text{Hz}$，则$\Delta t = 0.01\,\text{s}$。
- **作用**：为插值提供高分辨率时间网格，匹配无人机控制器的更新频率，确保轨迹可实时跟踪。

#### **3. 三次样条插值生成密集航点**
```python
cs_x = CubicSpline(time_raw, raw_waypoints[:, 0])
dense_waypoints = np.column_stack((cs_x(time_dense), cs_y(time_dense), cs_z(time_dense)))
```

- **数学公式**：
  - 对每个坐标轴（x, y, z）构建分段三次多项式：
    $$
    s_x(t) = a_i (t - t_i)^3 + b_i (t - t_i)^2 + c_i (t - t_i) + d_i \quad \text{for} \quad t \in [t_i, t_{i+1}]
    $$

系数$a_i, b_i, c_i, d_i$通过以下条件求解：
- **插值条件**：$s_x(t_j) = p_{j,x}$（位置匹配）。
- **连续性条件**：$s_x \in C^2[t_{\min}, t_{\max}]$（一阶导数$s_x'$和二阶导数$s_x''$连续）。
  - 密集航点：$\mathbf{p}_k = [s_x(t_k), s_y(t_k), s_z(t_k)]^T$。
- **原理**：
  - 三次样条插值保证轨迹光滑（加速度连续），优于线性插值或多项式插值（后者易振荡）。`CubicSpline`默认使用"not-a-knot"边界条件，避免端点突变。
  - 误差收敛速度为$O(h^4)$（$h$为节点间距），高精度适合动力学仿真。
- **作用**：将稀疏航点转化为连续轨迹，确保无人机运动平滑（减少急停或抖动），同时保留原始路径形状。

#### **4. 速度、加速度计算与动态曲率限制**
```python
velocity = np.gradient(dense_waypoints, axis=0) * control_freq_hz
acceleration = np.gradient(velocity, axis=0) * control_freq_hz
acc_magnitude = np.linalg.norm(acceleration, axis=1)
for idx in np.where(acc_magnitude > max_acc)[0]:
    dense_waypoints[idx] = 0.5 * (dense_waypoints[idx - 1] + dense_waypoints[idx + 1])
```

- **数学公式**：
  - **速度计算**：
    $$
    \mathbf{v}_k = \frac{\Delta \mathbf{p}}{\Delta t} \approx \frac{\mathbf{p}_{k+1} - \mathbf{p}_{k-1}}{2 \Delta t} \quad \text{(中心差分)}
    $$

其中$\Delta t = 1 / f_{\text{ctrl}}$。
  - **加速度计算**：
    $$
    \mathbf{a}_k = \frac{\Delta \mathbf{v}}{\Delta t} \approx \frac{\mathbf{v}_{k+1} - \mathbf{v}_{k-1}}{2 \Delta t}
    $$

  - **加速度大小**：$a_k = \|\mathbf{a}_k\| = \sqrt{a_{x,k}^2 + a_{y,k}^2 + a_{z,k}^2}$。
  - **平滑处理**（当$a_k > 2g$）：
    $$
    \mathbf{p}_k \leftarrow \frac{1}{2} (\mathbf{p}_{k-1} + \mathbf{p}_{k+1})
    $$

其中$g = 9.81\,\text{m/s}^2$。
- **原理**：
  - `np.gradient`使用中心差分（内部点）和单侧差分（边界）计算梯度，精度为$O(\Delta t^2)$。乘以$f_{\text{ctrl}}$将离散差分转为物理导数（因$\Delta t = 1/f_{\text{ctrl}}$)。
  - 加速度阈值（2g）源于工程实践：
- 超过2g的加速度可能导致无人机失稳或结构损伤。
- 平滑处理通过局部平均降低曲率突变，等效于低通滤波，确保动力学可行性。
- **作用**：
  - **动态曲率限制**：加速度与轨迹曲率$\kappa$相关（$\kappa \propto \|\mathbf{a}\|$)，限制$a_k \leq 2g$防止侧滑或翻车（尤其在高速转弯时）。
  - **实时修正**：处理后的轨迹满足$\max \|\mathbf{a}\| \leq 2g$，符合安全标准。

#### **5. 输出存储**
```python
INIT_XYZS[i] = initial_pos
TARGET_POS.append(dense_waypoints)
```

- **数学表示**：存储初始位置$\mathbf{p}_0$和修正后的密集航点序列$\{\mathbf{p}_k\}_{k=0}^{m-1}$。
- **作用**：为每个无人机提供可行轨迹，用于后续控制算法（如PID或模型预测控制）。

---

### **整体原理与作用**
#### **原理**
- **轨迹平滑性**：三次样条插值确保位置、速度、加速度连续（$C^2$连续），避免不连续点导致的控制振荡。
- **物理可行性**：
  - 加速度阈值（2g）基于无人机动力学极限，防止电机饱和或失稳。
  - 动态曲率限制通过局部平滑处理，保证轨迹曲率有界（$\kappa \leq \kappa_{\max}$)，符合最小转弯半径约束。
- **数值稳定性**：`np.gradient`使用自适应差分（边界用一阶，内部用二阶），避免数值发散。

#### **作用**
1. **轨迹优化**：将粗糙的离散航点转化为高分辨率、平滑的轨迹，提升跟踪精度。
2. **安全保证**：通过加速度限制，确保轨迹在物理约束内（如最大推力），防止事故。
3. **实时性**：插值和平滑处理计算高效，适合嵌入式系统或仿真。
4. **通用性**：适用于多无人机协同（`file_list`遍历），可扩展至机器人路径规划。

#### **工程背景**
- **无人机/车辆轨迹规划**：代码类似自动驾驶中的轨迹优化，其中曲率限制防止高速侧滑，加速度阈值确保乘客舒适性。
- **信号处理**：加速度阈值法源于小波去噪和冲击检测（如2g阈值广泛用于惯性导航）。
- **控制理论**：密集航点匹配控制频率（如100Hz），避免欠采样导致的跟踪误差。

---

# 三次样条插值：原理、公式与实现

## 三次样条的数学公式

### A. 分段三次多项式表示

假设我们有 N+1 个数据点 (xj​,yj​)，其中 j=0,1,…,N，并且 x0​<x1​<⋯<xN​。这些点定义了 N 个区间 [xj​,xj+1​]。在每个区间 Ij​=[xj​,xj+1​] 上，样条函数 S(x) 由一个三次多项式 Sj​(x) 表示。

为了方便推导和分析，通常将第 j 段（即区间 [xj​,xj+1​] 上）的多项式 Sj​(x) 写成相对于其左端点 xj​ 的形式：

Sj​(x)=aj​(x−xj​)3+bj​(x−xj​)2+cj​(x−xj​)+dj​for x∈[xj​,xj+1​]

这种形式被称为“移位形式”。例如，SciPy库中的 CubicSpline 实现中，其系数 c[k, i] 对应于项 (x−xi​)3−k 在区间 [xi​,xi+1​] 上的系数 4。这意味着对于第 j 个分段（在 xj​ 和 xj+1​ 之间），多项式可以表示为 Sj​(x)=c0,j​(x−xj​)3+c1,j​(x−xj​)2+c2,j​(x−xj​)+c3,j​。与我们上面定义的 aj​,bj​,cj​,dj​ 对应起来即：aj​=c0,j​, bj​=c1,j​, cj​=c2,j​, dj​=c3,j​。

采用 (x−xj​) 的幂次形式，其便利性在于当 x=xj​ 时，除了常数项 dj​ 外，所有其他项都为零。这使得在施加插值条件 Sj​(xj​)=yj​ 时，可以直接得到 dj​=yj​，从而简化了方程组的建立过程。虽然多项式的表示形式（例如，是 aj​x3+… 还是 aj​(x−xj​)3+…）会影响系数推导的代数复杂性，但不会改变样条函数的基本性质。

### B. 插值约束：通过数据点

样条函数必须通过所有给定的数据点。对于在区间 [xj​,xj+1​] 上的每一段 Sj​(x)：

1. 在左端点：Sj​(xj​)=yj​
2. 在右端点：Sj​(xj+1​)=yj+1​

使用移位形式 Sj​(x)=dj​+cj​(x−xj​)+bj​(x−xj​)2+aj​(x−xj​)3：

- 由第一个条件，Sj​(xj​)=dj​=yj​。这直接确定了每个分段的 N 个 dj​ 系数 (共 N 个分段，从 j=0 到 N−1) 1。
- 令 hj​=xj+1​−xj​ 表示第 j 个区间的长度。则由第二个条件，Sj​(xj+1​)=dj​+cj​hj​+bj​hj2​+aj​hj3​=yj+1​。

这些插值条件提供了 2N 个方程（如果我们认为 dj​=yj​ 确定了 N 个系数，那么第二个条件则提供了另外 N 个方程）。

### C. 内部节点的连续性条件

在每个内部节点 xj​ (对于 j=1,…,N−1) 处，相邻的两个多项式片段 Sj−1​(x) 和 Sj​(x) 必须平滑连接。

1. C0 连续性 (位置连续性):
    
    Sj−1​(xj​)=Sj​(xj​)=yj​。
    
    这个条件由插值约束 Sj−1​(xj​)=yj​ 和 Sj​(xj​)=yj​ 自动满足 1。
    
2. C1 连续性 (斜率/速度连续性):
    
    一阶导数必须相等：Sj−1′​(xj​)=Sj′​(xj​) 1。
    
    对于 Sj​(x)=dj​+cj​(x−xj​)+bj​(x−xj​)2+aj​(x−xj​)3，其一阶导数为 Sj′​(x)=cj​+2bj​(x−xj​)+3aj​(x−xj​)2。
    
    因此，Sj′​(xj​)=cj​。
    
    而 Sj−1′​(xj​)=cj−1​+2bj−1​(xj​−xj−1​)+3aj−1​(xj​−xj−1​)2=cj−1​+2bj−1​hj−1​+3aj−1​hj−12​。
    
    所以，cj​=cj−1​+2bj−1​hj−1​+3aj−1​hj−12​。
    
    这为 N−1 个内部节点提供了 N−1 个方程。
    
3. C2 连续性 (曲率/加速度连续性):
    
    二阶导数必须相等：Sj−1′′​(xj​)=Sj′′​(xj​) 1。
    
    Sj′′​(x)=2bj​+6aj​(x−xj​)。
    
    因此，Sj′′​(xj​)=2bj​。
    
    而 Sj−1′′​(xj​)=2bj−1​+6aj−1​(xj​−xj−1​)=2bj−1​+6aj−1​hj−1​。
    
    所以，2bj​=2bj−1​+6aj−1​hj−1​。
    
    这为 N−1 个内部节点提供了另外 N−1 个方程。
    

C2 连续性是三次样条区别于更简单的分段多项式（如线性或二次样条）的决定性特征，并赋予了它们特有的平滑性。这意味着曲率是连续的，这在许多物理应用中（例如，轨迹中的连续加速度）是必需的。如果二阶导数不连续，将表现为曲线“弯曲程度”的突然改变。在物理意义上，如果样条表示随时间变化的路径，二阶导数的不连续意味着加速度的瞬时变化（无限大的加加速度），这通常是不符合物理规律的，或者对于机械系统来说是不可取的。

### D. 建立系数方程组

我们有 N 个三次多项式 S0​(x),…,SN−1​(x)。每个 Sj​(x) 有4个未知系数（在移位形式中为 aj​,bj​,cj​,dj​）。因此，总共有 4N 个未知数。

从上述条件中，我们得到的方程数量为：

- Sj​(xj​)=yj​⟹dj​=yj​：N 个方程（或者说确定了 N 个系数）。
- Sj​(xj+1​)=yj+1​：N 个方程。
- Sj−1′​(xj​)=Sj′​(xj​)：N−1 个方程。
- Sj−1′′​(xj​)=Sj′′​(xj​)：N−1 个方程。

总方程数为 N+N+(N−1)+(N−1)=4N−2 1。

为了唯一确定 4N 个系数，我们还缺少 4N−(4N−2)=2 个方程。这两个额外的方程由边界条件提供。

这个关于系数的方程组是线性的。两个方程的缺失表明，样条函数在其两个端点 x0​ 和 xN​ 处的行为仅由插值条件和内部连续性条件是无法完全确定的。内部连续性条件连接了相邻的多项式片段。然而，第一个片段 S0​(x) 在 x0​ 处没有前一个片段来约束其导数，类似地，SN−1​(x) 在 xN​ 处也没有后一个片段。边界条件通过在这些端点施加特定的行为来填补这一空白。

## III. 边界条件的关键作用

### A. 边界条件为何至关重要

如前所述，对于 4N 个未知多项式系数，插值条件和内部节点处的连续性条件共提供了 4N−2 个线性方程。为了得到一个唯一可解的方程组，还需要两个额外的约束条件，这便是边界条件的作用 1。

边界条件的选择对样条曲线的形状有显著影响，尤其是在数据区间的端点附近。它们不仅仅是数学上的形式要求，更代表了对被插值函数或系统在已知数据范围边界处行为的假设。不恰当的边界条件选择可能导致不自然或误导性的插值结果。例如，如果我们要插值一个机器人从静止开始运动的轨迹，那么在起点施加一个零一阶导数（即夹持边界条件）是一个具有物理意义的约束。如果我们没有这类先验信息，那么选择“自然”或“非节点”边界条件可能更为合适，因为它们作出的特定假设较少。

### B. 常见边界条件的详细分析

以下是几种常见的三次样条边界条件：

#### 1. 自然样条 (Natural Splines)  
1. 自然样条 (zìrán yàngtiáo)

- **定义：** 在两个端点处的二阶导数为零：S′′(x0​)=0 和 S′′(xN​)=0 1。
- **数学含义：** 若 Sj​(x)=dj​+cj​(x−xj​)+bj​(x−xj​)2+aj​(x−xj​)3，则 Sj′′​(xj​)=2bj​。因此，对于第一个分段 S0​(x)，在 x0​ 处有 2b0​=0⟹b0​=0。对于最后一个分段 SN−1​(x)，在 xN​ 处的条件是 SN−1′′​(xN​)=0。由于 SN−1′′​(x)=2bN−1​+6aN−1​(x−xN−1​)，在 x=xN​ (即 x−xN−1​=hN−1​) 处，我们有 2bN−1​+6aN−1​hN−1​=0。
- **对端点的影响：** 样条曲线在端点处没有曲率，这意味着它趋向于变成一条直线。视觉上，“函数陡峭程度的变化在第一个和最后一个点接近于零” 1。当没有关于端点导数的其他信息时，这种边界条件通常被认为看起来“最好”或最“自然” 1。
- **更深层的特性 (变分性质)：** 自然样条具有一个显著的特性：在所有通过给定数据点且二阶导数连续的函数中，自然样条使得其二阶导数的平方在整个区间上的积分 $\int_{x_0}^{x_N}^2 dx$ 最小 5。这个积分可以解释为一根细弹性梁的总弯曲能量。 可以想象一根有弹性的细长尺子（称为弹性杆）被约束必须通过所有数据点。它自然形成的形状将是使其总弯曲能量最小的形状。这个形状就对应于自然三次样条。这种“最小能量”或“尽可能平滑”的特性，是它通常在视觉上令人愉悦并被称为“自然”的原因。

#### 2. 夹持样条 (Clamped Splines)  
2. 夹持样条

- **定义：** 在两个端点处的一阶导数值被指定：S′(x0​)=y0′​ 和 S′(xN​)=yN′​，其中 y0′​ 和 yN′​ 是已知的导数值 2。一种常见情况是“零夹持”，即 y0′​=0 和 yN′​=0 3。
- **数学含义：** 若 Sj​(x)=dj​+cj​(x−xj​)+bj​(x−xj​)2+aj​(x−xj​)3，则 Sj′​(xj​)=cj​。因此，对于第一个分段 S0​(x)，在 x0​ 处有 c0​=y0′​。对于最后一个分段 SN−1​(x)，在 xN​ 处的条件是 SN−1′​(xN​)=yN′​。由于 SN−1′​(x)=cN−1​+2bN−1​(x−xN−1​)+3aN−1​(x−xN−1​)2，在 x=xN​ 处，我们有 cN−1​+2bN−1​hN−1​+3aN−1​hN−12​=yN′​。
- **对端点的影响：** 允许精确控制样条在其起点和终点的斜率（切线）。如果边界处的变率（例如，初始/最终速度）是已知的，这将非常有用 5。如果导数信息准确，“与自然样条相比，通常在端点附近表现出较少的振荡” 5。
- **更深层的考量 (物理真实性)：** 夹持条件对于结合已知的物理约束非常有效。例如，如果要插值一个从静止开始并最终停止的物体的轨迹，设置 S′(x0​)=0 和 S′(xN​)=0 可以确保插值路径正确反映这些零速度条件。然而，如果指定的导数值不正确，可能会迫使样条在边界附近发生不自然的扭曲，以同时满足这些导数要求和通过相邻数据点。如果一个物理系统的边界行为（如起始速度）是已知的，通过夹持条件将其直接编码到数学模型中，可以得到更忠实的表示。样条被“强制”具有特定的斜率，如果该斜率是正确的，则非常有利；如果是一个不良的假设，则可能有害。

#### 3. “非节点”样条 ('Not-a-Knot' Splines)  
3. “非节点”样条

- **定义：** 此条件要求样条的三阶导数在第二个节点 x1​ 和倒数第二个节点 xN−1​ 处是连续的。即 S0′′′​(x1​)=S1′′′​(x1​) 和 SN−2′′′​(xN−1​)=SN−1′′′​(xN−1​) （1 中对于 N 个多项式使用的是 x2​ 和 xn​，这对应于 N+1 个数据点和 N 个多项式 S0​…SN−1​ 的 x1​ 和 xN−1​）。 由于三次多项式 aj​(x−xj​)3+… 的三阶导数是 6aj​，这意味着 a0​=a1​ 且 aN−2​=aN−1​ 1。 SciPy 3 提供的等效解释是“曲线端点的第一段和第二段是同一个多项式”，类似地，最后两段也是同一个多项式。这意味着 S0​(x) 和 S1​(x) 是同一个三次多项式的不同部分，同样 SN−2​(x) 和 SN−1​(x) 也是同一个三次多项式的不同部分。
- **对端点的影响：** 当没有关于边界导数的特定信息时，这通常是软件包（如 SciPy）中的默认条件 3。它倾向于产生平滑的结果，而不做诸如零曲率或零斜率之类的强假设。
- **特殊情况** 3：
    - 如果只有 N+1=2 个数据点（即 N=1 个分段，索引为0）：条件被替换为一阶导数等于线性插值的斜率。
    - 如果只有 N+1=3 个数据点（即 N=2 个分段，索引为0和1）并且两端都使用“非节点”条件：解是一个通过这3个点的抛物线（这意味着如果它是在 [x0​,x2​] 上的单个三次曲线，则 a0​=0）。
- **更深层的考量 (隐含的平滑性)：** “非节点”条件本质上是说：“不要在 x1​ 和 xN−1​ 处强加人为的断点（数学意义上不同多项式连接的‘节点’）。”通过使前两个多项式片段相同（以及最后两个相同），它允许由最开始几个（或最后几个）数据点定义的自然三次形式进一步延伸，从而导致由数据本身决定的更平滑的过渡，而不是像 S′′=0 那样由施加的数学条件决定。 强制 S0′′′​(x1​)=S1′′′​(x1​) 意味着曲率的变化率在 x1​ 处是连续的。由于 S0​ 和 S1​ 在 x1​ 处已经是 C2 连续的，使其三阶导数（对于三次多项式是常数）匹配，意味着 a0​=a1​。这有效地将 S0​ 和 S1​ 合并为一个跨越 [x0​,x2​]（通过 (x0​,y0​),(x1​,y1​),(x2​,y2​)）的单一三次多项式。这减少了“真正”不同多项式段的数量，有效地用掉了两个自由度。

### C. 对样条行为和轨迹形状的比较影响

边界条件的选择是一个建模决策。“自然”样条施加了一种特定类型的平滑性（最小弯曲能量）。“夹持”样条结合了明确的先验知识。“非节点”样条是一个限制性较小的条件，让数据在边界附近“自己说话”。“最佳”选择取决于具体应用场景以及关于被建模系统的任何可用先验信息。例如，如果插值梁的挠度，“自然”条件可能在物理上是合理的。如果插值机器人从静止开始的运动，“夹持”（零速度）条件是合适的。如果只是对没有已知端点行为的统计数据拟合一条平滑曲线，“非节点”通常是一个稳健的默认选择。

下表总结了常见边界条件的核心差异，有助于用户根据具体需求选择合适的条件。

**表1：三次样条边界条件比较**

|   |   |   |   |   |
|---|---|---|---|---|
|**边界条件**|**数学定义 (在 x0​,xN​ 处)**|**对样条端点的影响**|**典型用例/选择理由**|**来源**|
|**自然样条**|S′′(x0​)=0, S′′(xN​)=0|端点曲率为零；样条趋于变直。“陡峭程度的变化接近于零。”|无端点导数信息；通过最小化 ∫(S′′)2dx 寻求“最平滑”曲线。通常视觉效果好。|1|
|**夹持样条**|S′(x0​)=y0′​, S′(xN​)=yN′​ (指定的 y0′​,yN′​)|端点斜率（切线）固定。如果导数正确，可减少端点振荡。|已知端点导数（例如速度）。例如，物体从静止开始/结束 (y0′​=yN′​=0)。|2|
|**非节点样条**|S′′′(x1−​)=S′′′(x1+​), S′′′(xN−1−​)=S′′′(xN−1+​) (等效于 S0​≡S1​, SN−2​≡SN−1​)  <br>S′′′(x1−​)=S′′′(x1+​) ， S′′′(xN−1−​)=S′′′(xN−1+​) (等效于 S0​≡S1​ ， SN−2​≡SN−1​ )|前/后两个多项式段相同。由端点附近数据决定平滑过渡。|无端点导数信息时的默认选择；避免强加任意零值。通用性好。|1|

## IV. 工作原理：构建三次样条

### A. 建立方程组

一种常见且具有指导意义的方法是求解每个节点 xj​ (对于 j=0,…,N) 处的未知二阶导数值 Mj​=S′′(xj​)。

第 j 段（在 xj​ 和 xj+1​ 之间）的多项式 Sj​(x) 可以用 yj​,yj+1​,Mj​,Mj+1​ 表示 2：

Sj​(x)=Mj​6hj​(xj+1​−x)3​+Mj+1​6hj​(x−xj​)3​+(yj​−6Mj​hj2​​)hj​xj+1​−x​+(yj+1​−6Mj+1​hj2​​)hj​x−xj​​

其中 hj​=xj+1​−xj​。

对内部节点 xj​ (j=1,…,N−1) 应用 C1 连续性条件 Sj−1′​(xj​)=Sj′​(xj​)，可以导出一个包含 Mj−1​,Mj​,Mj+1​ 的线性方程组：

hj−1​Mj−1​+2(hj−1​+hj​)Mj​+hj​Mj+1​=6(hj​yj+1​−yj​​−hj−1​yj​−yj−1​​)

这构成了 N−1 个方程，包含 N+1 个未知数 (M0​,…,MN​)。

两个边界条件提供了其余的两个方程：

- **自然样条：** M0​=0,MN​=0。将这些值代入，求解关于 M1​,…,MN−1​ 的 (N−1)×(N−1) 三对角线性方程组。
- **夹持样条：** 关于 S′(x0​)=y0′​ 和 S′(xN​)=yN′​ 的方程分别用 M0​,M1​ 和 MN−1​,MN​ 表示，这会修改方程组的第一行和最后一行，求解 M0​,…,MN​。系统通常仍然是三对角的或接近三对角。
- **非节点样条：** 条件 S0′′′​(x1​)=S1′′′​(x1​) 和 SN−2′′′​(xN−1​)=SN−1′′′​(xN−1​) 也会导出关于 Mj​ 的线性方程（例如，如果 x0​,x1​,x2​ 是前三个节点，一种推导会得到 h1​M0​−(h0​+h1​)M1​+h0​M2​=0）。这些条件会改变系统的结构，但系统仍然是可解的。

另一种方法，如 SciPy 3 中所做的，是直接为所有 4N 个多项式系数 ck,j​ 建立一个包含所有插值、连续性和边界条件的更大的 4N×4N 方程组。这个系统是带状的，不一定是三对角的。

### B. 求解未知系数

如果关于 Mj​ 的方程组是三对角的（对于自然样条和夹持样条很常见），可以使用托马斯算法（一种特殊的高斯消元法）以 O(N) 的运算复杂度非常高效地求解 5。对于更一般的带状多项式系数方程组，则使用专门的带状矩阵求解器 2。

### C. 重构每个分段的多项式

一旦求得 Mj​ 值，每个分段 Sj​(x)=dj​+cj​(x−xj​)+bj​(x−xj​)2+aj​(x−xj​)3 的系数 aj​,bj​,cj​,dj​ 可以确定如下：

- dj​=yj​
- bj​=Mj​/2
- aj​=(Mj+1​−Mj​)/(6hj​)
- cj​=(yj+1​−yj​)/hj​−hj​/6(Mj+1​+2Mj​)

如果采用 SciPy 的直接系数方法（Sj​(x)=c0,j​(x−xj​)3+c1,j​(x−xj​)2+c2,j​(x−xj​)+c3,j​），这些系数 ck,j​ 就是求解更大方程组的直接输出 3。

首先求解二阶导数 Mj​ 的方法在教学上很有用，因为它清楚地显示了常见边界条件下的三对角结构以及 Mj​ 作为曲率代表的角色。然而，对于处理各种边界条件的通用库来说，直接求解多项式系数可能更容易实现，尽管其系统矩阵更大。Mj​ 值具有明确的物理意义（与梁中的弯矩成正比）。三对角系统是由于局部依赖性自然产生的：通过应用于共享节点 xj​ 的分段的 C1 连续性条件，Mj​ 仅受 Mj−1​ 和 Mj+1​ 的直接影响。这种局部结构导致了高效的求解算法。

**表2：自然三次样条构建（求解 Mj​）的方程摘要**

|   |   |   |   |
|---|---|---|---|
|**步骤**|**描述**|**内部节点 xj​ (j=1,…,N−1) 的关键方程**|**求解的未知数**|
|**1. 定义 hj​**|每个区间的长度|hj​=xj+1​−xj​|-|
|**2. 插值**|样条通过 (xj​,yj​)|Sj​(xj​)=yj​, Sj​(xj+1​)=yj+1​|(用于系数重构)|
|**3. C1 连续性**|Sj−1′​(xj​)=Sj′​(xj​)|导致： hj−1​Mj−1​+2(hj−1​+hj​)Mj​+hj​Mj+1​=6(hj​yj+1​−yj​​−hj−1​yj​−yj−1​​)  导致： hj−1​Mj−1​+2(hj−1​+hj​)Mj​+hj​Mj+1​=6(hj​yj+1​−yj​​−hj−1​yj​−yj−1​​)|M1​,…,MN−1​|
|**4. 边界条件 (自然)**|S′′(x0​)=0, S′′(xN​)=0|M0​=0, MN​=0|M0​,MN​ (直接设置)|
|**5. 系数重构**|对于 Sk​(t)=ak​t3+bk​t2+ck​t+dk​ 其中 t=(x−xk​)|dk​=yk​, bk​=Mk​/2, ak​=(Mk+1​−Mk​)/(6hk​), ck​=(yk+1​−yk​)/hk​−hk​(Mk+1​+2Mk​)/6|每个分段的 ak​,bk​,ck​,dk​|

此表提供了在求解二阶导数时自然三次样条构建过程的简明数学路线图。它清楚地将概念性条件（插值、连续性）与算法中使用的特定方程（特别是形成 Mj​ 的三对角系统）联系起来。这有助于理解“工作原理”。


   
